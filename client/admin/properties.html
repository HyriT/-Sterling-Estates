<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Properties | Admin Panel</title>
  <link rel="stylesheet" href="admin.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
   
  /* Modal overlay */
#listing-modal {
  display: none; 
  position: fixed;
  z-index: 1000;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.5); /* slightly lighter overlay */
  justify-content: center;
  align-items: center;
  transition: opacity 0.3s ease;
  opacity: 0;
}

#listing-modal.active {
  display: flex;
  opacity: 1;
}

/* Modal content */
#listing-modal .modal-content {
  background: #fff;
  padding: 30px 35px;
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  position: relative;
  transform: translateY(-20px);
  transition: transform 0.3s ease;
}

#listing-modal.active .modal-content {
  transform: translateY(0);
}

/* Modal header */
#listing-modal h2 {
  margin-top: 0;
  font-size: 1.8rem;
  color: #333;
  text-align: center;
  margin-bottom: 20px;
}

/* Close button */
#listing-modal .close-btn {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 26px;
  font-weight: bold;
  color: #888;
  cursor: pointer;
  border: none;
  background: none;
  transition: color 0.2s;
}

#listing-modal .close-btn:hover {
  color: #ff5c5c;
}

/* Form styling */
#listing-form {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  justify-content: space-between;
}

#listing-form label {
  font-weight: 500;
  margin-bottom: 5px;
  display: block;
  color: #555;
}

#listing-form input,
#listing-form select {
  width: calc(50% - 10px);
  padding: 8px 12px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 0.95rem;
  transition: border-color 0.2s;
}

#listing-form input:focus,
#listing-form select:focus {
  border-color: #007bff;
  outline: none;
}

/* Full width inputs */
#listing-form input.full-width {
  width: 100%;
}

/* Checkbox & radio */
#listing-form .checkbox-group {
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Buttons */
#listing-form button {
  padding: 10px 18px;
  border: none;
  border-radius: 8px;
  background-color: #007bff;
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  transition: background-color 0.2s, transform 0.2s;
}

#listing-form button:hover {
  background-color: #0056b3;
  transform: translateY(-1px);
}

#listing-form button.cancel-btn {
  background-color: #6c757d;
}

#listing-form button.cancel-btn:hover {
  background-color: #5a6268;
}

/* Scrollbar for modal */
#listing-modal .modal-content::-webkit-scrollbar {
  width: 8px;
}

#listing-modal .modal-content::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,0.2);
  border-radius: 4px;
}


    /* Update/Delete button styles */
    button.update-btn, button.delete-btn {
      margin: 0 2px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }
button.update-btn,
button.delete-btn {
  color: white;
  border: none;
  border-radius: 3px;
  width: 60px;
  padding: 4px;
  cursor: pointer;
  font-size: 14px;
  margin-top: 6px; /* consistent spacing */
  transition: background-color 0.3s ease;
}

button.update-btn {
  background-color: #2d89ef;
}
button.delete-btn {
  background-color: #d9534f;
}
    /* New Listing button */
    #new-listing-btn {
      margin-bottom: 1rem;
      padding: 8px 16px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    #new-listing-btn:hover {
      background-color: #218838;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    table th, table td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: center;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <aside class="sidebar">
      <div>
        <h2>SE Admin</h2>
  <ul>
  <li>
    <a href="#"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
  </li>
  <li>
    <a href="appraisals.html"><i class="fas fa-file-signature"></i> Appraisals</a>
  </li>
  <li>
    <a href="users.html"><i class="fas fa-users"></i> Users</a>
  </li>
  <li>
    <a href="admin-agent.html"><i class="fas fa-user-tie"></i> Agent</a>
  </li>
  <li class="active">
    <a href="properties.html"><i class="fas fa-building"></i> Properties</a>
  </li>
  <li>
    <a href="statistic.html"><i class="fas fa-chart-bar"></i> Statistics</a>
  </li>
  <li>
    <a href="settings.html"><i class="fas fa-cog"></i> Settings</a>
  </li>
</ul>

      </div>
      <p style="font-size: 13px;">&copy; 2025 Sterling Estates</p>
    </aside>

    <main class="main-panel">
      <header>
        <h1>Mange Properties</h1>
        <div class="admin-user">
          <div class="avatar" onclick="toggleDropdown()">A</div>
          <div class="dropdown" id="profile-dropdown" style="display:none;">
            <a href="admin-profil.html">My Profile</a>
            <a href="#" onclick="logout()">Logout</a>
          </div>
        </div>
      </header>
      
      <section class="content-section">
        <div class="controls">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="search-input" placeholder="Search properties...">
          </div>
         <button id="new-listing-btn" class="btn btn-primary">
  <i class="fas fa-plus"></i> Add New Properties
</button>

        </div>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Description</th>
              <th>Address</th>
              <th>Regular Price</th>
              <th>Discount Price</th>
              <th>Bathrooms</th>
              <th>Bedrooms</th>
              <th>Furnished</th>
              <th>Parking</th>
              <th>Type</th>
              <th>Offer</th>
              <th>Image</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="users-table-body"></tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Modal for Create/Update Listing -->
  <div id="listing-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content">
      <button class="close-btn" aria-label="Close modal">&times;</button>
      <h2 id="modal-title">Create / Update Property</h2>
      <form id="listing-form">
        <input type="hidden" id="listing-id" />
        <input type="text" id="name" placeholder="Name" required />
        <input type="text" id="description" placeholder="Description" required />
        <input type="text" id="address" placeholder="Address" required />
        <input type="number" id="regularPrice" placeholder="Regular Price" required min="0" />
        <input type="number" id="discountPrice" placeholder="Discount Price" min="0" />
        <input type="number" id="bathrooms" placeholder="Bathrooms" min="0" />
        <input type="number" id="bedrooms" placeholder="Bedrooms" min="0" />
        <label>
          Furnished:
          <input type="checkbox" id="furnished" />
        </label>
        <label>
          Parking:
          <input type="checkbox" id="parking" />
        </label>
        <select id="type">
          <option value="sale">Sale</option>
          <option value="rent">Rent</option>
        </select>
        <label>
          Offer:
          <input type="checkbox" id="offer" />
        </label>
        <input type="text" id="image" placeholder="Image URL" />
        <br />
        <button type="submit">Save</button>
        <button type="button" id="cancel-btn">Cancel</button>
      </form>
    </div>
  </div>

<script>
const modal = document.getElementById('listing-modal');
const newListingBtn = document.getElementById('new-listing-btn');
const closeBtn = modal.querySelector('.close-btn');
const cancelBtn = document.getElementById('cancel-btn');
const form = document.getElementById('listing-form');
const tableBody = document.getElementById('users-table-body');

const token = localStorage.getItem("token");
if (!token) {
  alert("Unauthorized! Please login again.");
  window.location.href = "./admin-login.html";
}

// Modal helpers
newListingBtn.addEventListener('click', () => { clearForm(); openModal(); });
closeBtn.addEventListener('click', closeModal);
cancelBtn.addEventListener('click', closeModal);
function openModal() { modal.classList.add('active'); }
function closeModal() { modal.classList.remove('active'); clearForm(); }
function clearForm() { document.getElementById('listing-id').value = ''; form.reset(); }

// Fetch properties
async function fetchProperties() {
  try {
    const res = await fetch("http://localhost:5000/api/listing/getAll", {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) throw new Error('Unauthorized. Please login again.');
    const data = await res.json();

    tableBody.innerHTML = "";
    data.forEach(p => {
      tableBody.innerHTML += `
        <tr data-id="${p._id}">
          <td>${p.name||"-"}</td>
          <td>${p.description||"-"}</td>
          <td>${p.address||"-"}</td>
          <td>${p.regularPrice!==undefined?`$${p.regularPrice}`:"-"}</td>
          <td>${p.discountPrice!==undefined?`$${p.discountPrice}`:"-"}</td>
          <td>${p.bathrooms??"-"}</td>
          <td>${p.bedrooms??"-"}</td>
          <td>${p.furnished?"Yes":"No"}</td>
          <td>${p.parking?"Yes":"No"}</td>
          <td>${p.type||"-"}</td>
          <td>${p.offer?"Yes":"No"}</td>
          <td>${p.imageUrls && p.imageUrls.length>0 ? `<img src="${p.imageUrls[0]}" style="width:60px;"/>`:"-"}</td>
          <td>
            <button class="update-btn">Update</button>
            <button class="delete-btn">Delete</button>
          </td>
        </tr>`;
    });
  } catch(err) {
    alert(err.message);
    console.error(err);
    if(err.message.includes("Unauthorized")) window.location.href="login.html";
  }
}

// Create / Update listing
form.addEventListener('submit', async e => {
  e.preventDefault();
  const id = document.getElementById('listing-id').value;
  const imageInput = document.getElementById("image").value;
  const imageUrls = imageInput ? [imageInput] : [];
  const userRef = "687f53bce93325ab32b7355a";

  const data = {
    name: document.getElementById('name').value.trim(),
    description: document.getElementById('description').value.trim(),
    address: document.getElementById('address').value.trim(),
    regularPrice: parseFloat(document.getElementById('regularPrice').value),
    discountPrice: parseFloat(document.getElementById('discountPrice').value)||0,
    bathrooms: parseInt(document.getElementById('bathrooms').value)||0,
    bedrooms: parseInt(document.getElementById('bedrooms').value)||0,
    furnished: document.getElementById('furnished').checked,
    parking: document.getElementById('parking').checked,
    type: document.getElementById('type').value,
    offer: document.getElementById('offer').checked,
    imageUrls, userRef
  };

  try {
    const url = id ? `http://localhost:5000/api/listing/update/${id}` : `http://localhost:5000/api/listing/create`;
    const method = id ? "PUT" : "POST";
    const res = await fetch(url, {
      method,
      headers: {
        "Content-Type":"application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify(data)
    });

    if(!res.ok) throw new Error("Unauthorized or failed to save listing");
    closeModal();
    await fetchProperties();
    alert(id?"Updated successfully":"Created successfully");
  } catch(err) {
    alert(err.message);
    if(err.message.includes("Unauthorized")) window.location.href="./admin-login.html";
  }
});

// Update / Delete buttons
tableBody.addEventListener('click', async e=>{
  const row = e.target.closest('tr'); if(!row) return;
  const id = row.dataset.id;

  if(e.target.classList.contains('update-btn')) {
    try {
      const res = await fetch(`http://localhost:5000/api/listing/get/${id}`, {
        headers:{ "Authorization":`Bearer ${token}`,
              "Content-Type": "application/json"
         }
      });
      if(!res.ok) throw new Error("Unauthorized");
      const listing = await res.json();
      Object.keys(listing).forEach(k=>{
        if(document.getElementById(k)) document.getElementById(k).value = listing[k];
      });
      openModal();
    } catch(err){ alert(err.message); }
  }

  if(e.target.classList.contains('delete-btn')) {
    if(!confirm("Delete this listing?")) return;
    try {
      const res = await fetch(`http://localhost:5000/api/listing/delete/${id}`, {
        method:"DELETE",
        headers:{ "Authorization":`Bearer ${token}`,
              "Content-Type": "application/json"

         }
      });
      if(!res.ok) throw new Error("Unauthorized");
      await fetchProperties();
      alert("Deleted successfully");
    } catch(err){ alert(err.message); }
  }
});

// Logout
function logout(){
  localStorage.removeItem("token");
  localStorage.removeItem("user");
  window.location.href="./admin-login.html";
}

document.addEventListener("DOMContentLoaded", fetchProperties);
const searchInput = document.getElementById('search-input');

searchInput.addEventListener('input', () => {
  const filter = searchInput.value.toLowerCase();
  const rows = tableBody.querySelectorAll('tr');

  rows.forEach(row => {
    const name = row.children[0].textContent.toLowerCase();
    const description = row.children[1].textContent.toLowerCase();
    const address = row.children[2].textContent.toLowerCase();

    if (name.includes(filter) || description.includes(filter) || address.includes(filter)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
});

</script>



</body>
</html>
