<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Properties | Admin Panel</title>
  <link rel="stylesheet" href="admin.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
   
    #listing-modal {
      display: none; 
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    #listing-modal.active {
      display: flex;
    }
    #listing-modal .modal-content {
      background: white;
      padding: 20px 25px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      position: relative;
    }
    #listing-modal h2 {
      margin-top: 0;
    }
    #listing-form input,
    #listing-form select {
      margin: 0.3rem 0.7rem 0.3rem 0;
      padding: 0.4rem;
      width: 140px;
    }
    #listing-form label {
      margin-right: 1rem;
      font-weight: normal;
    }
    #listing-form button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    #listing-modal .close-btn {
      position: absolute;
      top: 12px;
      right: 15px;
      font-size: 24px;
      font-weight: bold;
      color: #888;
      cursor: pointer;
      border: none;
      background: none;
    }
    #listing-modal .close-btn:hover {
      color: #333;
    }

    /* Update/Delete button styles */
    button.update-btn, button.delete-btn {
      margin: 0 2px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }
button.update-btn,
button.delete-btn {
  color: white;
  border: none;
  border-radius: 3px;
  width: 60px;
  padding: 4px;
  cursor: pointer;
  font-size: 14px;
  margin-top: 6px; /* consistent spacing */
  transition: background-color 0.3s ease;
}

button.update-btn {
  background-color: #2d89ef;
}
button.delete-btn {
  background-color: #d9534f;
}



    /* New Listing button */
    #new-listing-btn {
      margin-bottom: 1rem;
      padding: 8px 16px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    #new-listing-btn:hover {
      background-color: #218838;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    table th, table td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: center;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <aside class="sidebar">
      <div>
        <h2>MC Admin</h2>
         <ul>
  <li><a href="admin.html"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
  <li><a href="appraisals.html"><i class="fas fa-file-signature"></i> Appraisals</a></li>
  <li><a href="users.html"><i class="fas fa-users"></i> Users</a></li>
        <li ><a href="agent.html"><i class="fas fa-user-tie"></i> Agent</a></li>
  <li class="active"><a href="properties.html"><i class="fas fa-building"></i> Properties</a></li>
  <li><i class="fas fa-chart-bar"></i> Statistics</li>
  <li><i class="fas fa-cog"></i> Settings</li>
</ul>
      </div>
      <p style="font-size: 13px;">&copy; 2025 MC Real Estate</p>
    </aside>

    <main class="main-panel">
      <header>
        <h1>Mange Properties</h1>
        <div class="admin-user">
          <div class="avatar" onclick="toggleDropdown()">A</div>
          <div class="dropdown" id="profile-dropdown" style="display:none;">
            <a href="#">My Profile</a>
            <a href="#" onclick="logout()">Logout</a>
          </div>
        </div>
      </header>
      
      <section class="content-section">
        <div class="controls">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="search-input" placeholder="Search properties...">
          </div>
          <button class="btn btn-primary" onclick="openAddAgentModal()">
            <i class="fas fa-plus"></i> Add New Properties
          </button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Description</th>
              <th>Address</th>
              <th>Regular Price</th>
              <th>Discount Price</th>
              <th>Bathrooms</th>
              <th>Bedrooms</th>
              <th>Furnished</th>
              <th>Parking</th>
              <th>Type</th>
              <th>Offer</th>
              <th>Image</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="users-table-body"></tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Modal for Create/Update Listing -->
  <div id="listing-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content">
      <button class="close-btn" aria-label="Close modal">&times;</button>
      <h2 id="modal-title">Create / Update Property</h2>
      <form id="listing-form">
        <input type="hidden" id="listing-id" />
        <input type="text" id="name" placeholder="Name" required />
        <input type="text" id="description" placeholder="Description" required />
        <input type="text" id="address" placeholder="Address" required />
        <input type="number" id="regularPrice" placeholder="Regular Price" required min="0" />
        <input type="number" id="discountPrice" placeholder="Discount Price" min="0" />
        <input type="number" id="bathrooms" placeholder="Bathrooms" min="0" />
        <input type="number" id="bedrooms" placeholder="Bedrooms" min="0" />
        <label>
          Furnished:
          <input type="checkbox" id="furnished" />
        </label>
        <label>
          Parking:
          <input type="checkbox" id="parking" />
        </label>
        <select id="type">
          <option value="sale">Sale</option>
          <option value="rent">Rent</option>
        </select>
        <label>
          Offer:
          <input type="checkbox" id="offer" />
        </label>
        <input type="text" id="image" placeholder="Image URL" />
        <br />
        <button type="submit">Save</button>
        <button type="button" id="cancel-btn">Cancel</button>
      </form>
    </div>
  </div>

  <script>
    const modal = document.getElementById('listing-modal');
    const newListingBtn = document.getElementById('new-listing-btn');
    const closeBtn = modal.querySelector('.close-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const form = document.getElementById('listing-form');
    const tableBody = document.getElementById('users-table-body');

    // Open modal and clear form (for creating new listing)
    newListingBtn.addEventListener('click', () => {
      clearForm();
      openModal();
    });

    // Close modal
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);

    // Open modal helper
    function openModal() {
      modal.classList.add('active');
    }

    // Close modal helper
    function closeModal() {
      modal.classList.remove('active');
      clearForm();
    }

    // Fetch and render properties
    async function fetchProperties() {
      try {
        const res = await fetch("http://localhost:3000/api/listing/getAll");
        if (!res.ok) throw new Error('Failed to fetch properties');
        const data = await res.json();

        tableBody.innerHTML = "";

        data.forEach(property => {
          const row = `
            <tr data-id="${property._id}">
              <td>${property.name || "-"}</td>
              <td>${property.description || "-"}</td>
              <td>${property.address || "-"}</td>
              <td>${property.regularPrice !== undefined ? `$${property.regularPrice}` : "-"}</td>
              <td>${property.discountPrice !== undefined ? `$${property.discountPrice}` : "-"}</td>
              <td>${property.bathrooms ?? "-"}</td>
              <td>${property.bedrooms ?? "-"}</td>
              <td>${property.furnished ? "Yes" : "No"}</td>
              <td>${property.parking ? "Yes" : "No"}</td>
              <td>${property.type || "-"}</td>
              <td>${property.offer ? "Yes" : "No"}</td>
              <td>
                ${property.image 
                  ? `<img src="${property.image}" alt="Property Image" style="width: 60px; height: auto;" />` 
                  : "-"}
              </td>
              <td>
                <button class="update-btn">Update</button>
                <button class="delete-btn">Delete</button>
              </td>
            </tr>
          `;
          tableBody.innerHTML += row;
        });
      } catch (err) {
        console.error("Error fetching properties:", err);
        alert("Failed to load properties.");
      }
    }

    // Fill form for update
    function fillForm(listing) {
      document.getElementById('listing-id').value = listing._id || '';
      document.getElementById('name').value = listing.name || '';
      document.getElementById('description').value = listing.description || '';
      document.getElementById('address').value = listing.address || '';
      document.getElementById('regularPrice').value = listing.regularPrice || '';
      document.getElementById('discountPrice').value = listing.discountPrice || '';
      document.getElementById('bathrooms').value = listing.bathrooms || '';
      document.getElementById('bedrooms').value = listing.bedrooms || '';
      document.getElementById('furnished').checked = listing.furnished || false;
      document.getElementById('parking').checked = listing.parking || false;
      document.getElementById('type').value = listing.type || 'sale';
      document.getElementById('offer').checked = listing.offer || false;
      document.getElementById('image').value = listing.image || '';
    }

    // Clear form
    function clearForm() {
      document.getElementById('listing-id').value = '';
      form.reset();
    }

    // Handle form submit for create or update
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = document.getElementById('listing-id').value;
      const data = {
        name: document.getElementById('name').value.trim(),
        description: document.getElementById('description').value.trim(),
        address: document.getElementById('address').value.trim(),
        regularPrice: parseFloat(document.getElementById('regularPrice').value),
        discountPrice: parseFloat(document.getElementById('discountPrice').value) || 0,
        bathrooms: parseInt(document.getElementById('bathrooms').value) || 0,
        bedrooms: parseInt(document.getElementById('bedrooms').value) || 0,
        furnished: document.getElementById('furnished').checked,
        parking: document.getElementById('parking').checked,
        type: document.getElementById('type').value,
        offer: document.getElementById('offer').checked,
        image: document.getElementById('image').value.trim(),
      };

      try {
        let response;
        if (id) {
          // Update existing listing
          response = await fetch(`http://localhost:3000/api/listing/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
        } else {
          // Create new listing
          response = await fetch(`http://localhost:3000/api/listing`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
        }

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to save listing');
        }

        closeModal();
        await fetchProperties(); // Refresh table
        alert(id ? 'Listing updated successfully!' : 'Listing created successfully!');
      } catch (error) {
        alert('Error: ' + error.message);
      }
    });

    // Handle Update and Delete buttons with event delegation
    tableBody.addEventListener('click', async (e) => {
      const row = e.target.closest('tr');
      if (!row) return;

      const id = row.getAttribute('data-id');

      if (e.target.classList.contains('update-btn')) {
        // Fetch listing details and fill form for update + open modal
        try {
          const res = await fetch(`http://localhost:3000/api/listing/${id}`);
          if (!res.ok) throw new Error('Failed to fetch listing');
          const listing = await res.json();
          fillForm(listing);
          openModal();
        } catch (error) {
          alert('Failed to load listing for update: ' + error.message);
        }
      }

      if (e.target.classList.contains('delete-btn')) {
        if (!confirm('Are you sure you want to delete this listing?')) return;

        try {
          const res = await fetch(`http://localhost:3000/api/listing/${id}`, {
            method: 'DELETE',
          });

          if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.message || 'Failed to delete listing');
          }

          await fetchProperties(); // Refresh table
          alert('Listing deleted successfully!');
        } catch (error) {
          alert('Error deleting listing: ' + error.message);
        }
      }
    });

    // Dropdown and logout (same as before)
    function toggleDropdown() {
      const dropdown = document.getElementById("profile-dropdown");
      dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    }

    function logout() {
      alert("Logging out...");
      localStorage.removeItem("user");
      window.location.href = "login.html";
    }

    window.addEventListener("click", function(e) {
      if (!e.target.closest(".admin-user")) {
        document.getElementById("profile-dropdown").style.display = "none";
      }
    });

    // Load listings initially
    document.addEventListener("DOMContentLoaded", fetchProperties);
  </script>
</body>
</html>
